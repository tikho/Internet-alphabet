  <!doctype html>
  <html lang="ru">
  <head>
  <meta charset="utf-8">

  <title>internet alphabet</title>

  <!-- Latest compiled and minified Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="style.css">
  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
  <script src="js/handlebars-v4.0.5.js"></script>
  <script src="js/moment-with-locales.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/json2/20110223/json2.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
  <script src="js/jstorage.js"></script>

  </head>
  <body>

  <div class="top container">

    <div class="language-selector">

      <span><a href="en.html">EN</a></span>
      <span>RU</span>

    </div>

    <div class="logo center-block">
      <span>интернет алфавит</span><span id="cursor">|</span>
    </div>
    <div class="explainer-block">
      <p class="explainer center-block">Подсказки Гугла для каждой буквы русского алфавита собранные </p>
    </div>
  </div>

  <div class="alphabet">
    <!-- rendered by handlebars -->
  </div>

  <div class="phrases container">
    <!-- rendered by handlebars -->
  </div>

  <div class="footer container">
    <div class="sharing-block center-block">
      <!-- Go to www.addthis.com/dashboard to customize your tools -->
      <div class="addthis_native_toolbox center-block"></div>
    </div>
    <div class="made-by">
      Сделал <a class="made-by-link" href="http://www.tikho.ru">Иван Тихомиров</a>
    </div>
  </div>

  <script id="alphabet" type="text/x-handlebars-template">
  <div class="container">
  {{#grouped_each 4 this}}
    <div class="row">
      {{#each this}}
      <div class="col-xs-6 col-md-3 col-sm-6 alphabet-letter-block">
        <h1 class="letter-big">{{letter}}</h1>
        <h1 class="letter-small">{{letter}}</h1>
        <ul class="letter-list">
          {{#each suggests}}
                <li>                
                  <a class="suggest-url" href="https://www.google.com/search?q={{this}}">{{text-url}}</a>
                </li>
          {{/each}}
        </ul>
      </div>
      {{/each}}
    </div>
  {{/grouped_each}}
  </div>
  </script>


  <script id="phrases" type="text/x-handlebars-template">
  <h1 class="phrases-header">Бонус трэк</h1>
    <div class="container">
      {{#grouped_each 3 this}}
        <div class="row">
          {{#each this}}
          <div class="col-xs-12 col-sm-6 col-md-4 phrase-block">
            <p class="phrase">{{phrase}}</p>
            <ul class="phrase-list">
              {{#each suggests}}
                    <li class="phrase-suggest">                
                      <a class="suggest-url" href="https://www.google.com/search?q={{this}}">{{this}}</a>
                    </li>
              {{/each}}
            </ul>
          </div>
          {{/each}}
        </div>
      {{/grouped_each}}
    </div>
  </script>


  <script>

  var suggestCallBack; // global var for autocomplete jsonp
  var counter = 0;
  var googleResponseArray = [];

  $(document).ready(function () {

    var alphabet = "абвгдеёжзийклмнопрстуфхцчшщъыьэюя".split("");

    var phrases = ["как сохранить ", "где можно ", "почему ", "я хочу чтобы ", "как называется ", "я ударил ", "почему бы не ", "однажды я ", "что делать если ", "почему я всегда ", "безопасно ли ", "как мне "];


    // console.log($.jStorage.get("time", "no time") + " " + $.jStorage.get("suggestionsWithLetters", "no alphabet") + " " + $.jStorage.get("suggestionsWithPhrases", "no phrases"));

    if ($.jStorage.get("time-ru", "no time yet") === "no time yet"){
      // console.log("user came first time — no stored values");

      renderNew(alphabet, phrases);

    } else {
      // console.log("user was here — use stored time to check when he came last time");
        
      var now = moment().locale("ru").format('DD.MM.YYYY HH:mm');
      var storedTime = $.jStorage.get("time-ru");

      var timeDifference = moment(now, 'DD.MM.YYYY HH:mm').diff(moment(storedTime, 'DD.MM.YYYY HH:mm'));
      var timeDuration = moment.duration(timeDifference);
      var hourDifference = timeDuration.asHours();

      if (hourDifference < 0.5){
        // console.log("last time was less than hour ago, render stored values");

        renderStored();


      } else {
        // console.log("last time was longer than hour ago, refresh data and render");

        renderNew(alphabet, phrases);

      }

    }


    function renderNew(alphabet, phrases){

      $.each(alphabet, function(letter) {

          $.getJSON("https://suggestqueries.google.com/complete/search?callback=?",
            { 
              "hl":"ru", // Language   
              "jsonp":"suggestCallBack", // jsonp callback function name
              "q":alphabet[letter], // query term
              "output":"chrome"
            }
          );

          suggestCallBack = function (data) {

              googleResponseArray.push(data);

              counter++;

              if (counter == alphabet.length){
                googleResponseArray = googleResponseArray.sort(function(a,b){
                  if (a[0] < b[0])
                    return -1;
                  if (a[0] > b[0])
                    return 1;
                  return 0;
                }); // sorted array. Time to push it in object

                if (alphabet.indexOf('ё') > -1 && 
                    typeof googleResponseArray != 'undefined' && 
                    googleResponseArray.length > 0)
                {
                  googleResponseArray.splice(6, 0, googleResponseArray.slice(-1)[0]);
                  googleResponseArray.pop();
                }//checking for "ё"

                var suggestionsWithLetters = [];
                for (var i = 0; i < googleResponseArray.length; i++) {
                  var suggestWithLetter = {
                    letter: googleResponseArray[i][0],
                    suggests: googleResponseArray[i][1]
                  };
                  suggestionsWithLetters.push(suggestWithLetter);
                }

                var source   = $("#alphabet").html();
                var template = Handlebars.compile(source);

                var html = template(suggestionsWithLetters);
                $('.alphabet').append(html);

                //store alphabet JSON locally
                $.jStorage.set("suggestionsWithLetters-ru", suggestionsWithLetters);
              }

          };
      });


      var phraseGoogleResponseArray = [];
      var phraseCounter = 0;

      $.each(phrases, function(phrase) {

        $.getJSON("https://suggestqueries.google.com/complete/search?callback=?",
          { 
            "hl":"ru", // Language   
            "jsonp":"phraseSuggestCallBack", // jsonp callback function name
            "q":phrases[phrase], // query term
            "output":"chrome"
          }
          );

          phraseSuggestCallBack = function(data) {

            phraseGoogleResponseArray.push(data);
            phraseCounter++;

            if (phraseCounter == phrases.length){

                  phraseGoogleResponseArray = phraseGoogleResponseArray.sort(function(a,b){
                    if (a[0] < b[0])
                      return -1;
                    if (a[0] > b[0])
                      return 1;
                    return 0;
                  }); // sorted array. Time to push it in object

                var suggestionsWithPhrases = [];
                for (var i = 0; i < phraseGoogleResponseArray.length; i++) {
                    // console.log(phraseGoogleResponseArray)
                  var suggestWithPhrase = {
                    phrase: phraseGoogleResponseArray[i][0],
                    suggests: phraseGoogleResponseArray[i][1]
                  };
                  suggestionsWithPhrases.push(suggestWithPhrase);
                }

              var source   = $("#phrases").html();
                var template = Handlebars.compile(source);

                var html = template(suggestionsWithPhrases);
                $('.phrases').append(html);

                //store phrases JSON locally
                $.jStorage.set("suggestionsWithPhrases-ru", suggestionsWithPhrases);
            }
          };
      });
          

          var currentTime = moment().locale("ru").format('DD.MM.YYYY HH:mm');
          $.jStorage.set("time-ru", currentTime);

      var explainerText = $(".explainer").text();

      $(".explainer").text(explainerText + currentTime);

    }

    function renderStored(){

      // console.log("rendering stored alphabet suggestions");

      var suggestionsWithLetters = $.jStorage.get("suggestionsWithLetters-ru");

      var source   = $("#alphabet").html();
          var template = Handlebars.compile(source);

          var html = template(suggestionsWithLetters);
          $('.alphabet').append(html);



      // console.log("rendering stored phrases suggestions");

      var suggestionsWithPhrases = $.jStorage.get("suggestionsWithPhrases-ru");

        var source   = $("#phrases").html();
          var template = Handlebars.compile(source);

          var html = template(suggestionsWithPhrases);
          $('.phrases').append(html);


          var storedTime = $.jStorage.get("time-ru");

      var explainerText = $(".explainer").text();

      $(".explainer").text(explainerText + storedTime);

    }

  });

    Handlebars.registerHelper('grouped_each', function(every, context, options) {
      var out = "", subcontext = [], i;
      if (context && context.length > 0) {
          for (i = 0; i < context.length; i++) {
              if (i > 0 && i % every === 0) {
                  out += options.fn(subcontext);
                  subcontext = [];
              }
              subcontext.push(context[i]);
          }
          out += options.fn(subcontext);
      }
      return out;
    });

    Handlebars.registerHelper('text-url', function(){
      var suggest = this;
      // console.log(suggest);
      if (suggest.length > 26){
        suggest = suggest.slice(0, 26);
        suggest += "..."
      }

      return suggest;

    });

  </script>

  <!-- Go to www.addthis.com/dashboard to customize your tools -->
  <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-57589586e90cbb07"></script>


  </body>

  </html>